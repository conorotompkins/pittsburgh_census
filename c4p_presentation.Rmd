---
title: "C4P Presentation"
author: "Conor Tompkins"
date: "April 13, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

register_google(key = "AIzaSyBTJxUwvLUY3GiJgJ5cBSLEb_n1TPRjJPE")
```

#Packages

* Simple Features {sf}
* {tidycensus}
* {ggmap}


Get your census API key: https://api.census.gov/data/key_signup.html

configure environment
```{r}
library(tidycensus)
library(tidyverse)
library(sf)
library(tigris)
library(lwgeom)
library(ggmap)
library(janitor)

theme_set(theme_bw())

options(tigris_use_cache = TRUE,
        scipen = 4,
        digits = 3)

census_api_key("a16f3636406d2b544871e2ae49bb318c3ddcacba")


```

```{r include=FALSE}
library(kableExtra)
```

##{tidycensus}
gives access to census API. makes it easy to plot data on a map

Data
* census demographics
  * decennial
  * American Community Survey
* census geometries
  * country
  * county
  * zip code
  * blocks
  * tracts


##{sf}
simple features makes it easy to work with polygon data in R. uses familiar `tidyverse` framework

##{ggmap}
Uses Google Maps API to get basemaps


##Using `tidycensus`
Load variables
```{r}
variables_acs <- load_variables(2017, "acs5", cache = TRUE)

variables_acs %>% 
  head(5) %>% 
  kable() %>% 
  kable_styling()
```
```{r}
variables_dec <- load_variables(2010, "sf1", cache = TRUE)

variables_dec %>% 
  head(5) %>% 
  kable() %>% 
  kable_styling()
```

Plot the total population of continental U.S. states
```{r}
states <- get_decennial(geography = "state",
                           variables = c(total_pop = "P001001"),
                           geometry = TRUE,
                        output = "wide")

states %>% 
  filter(NAME != "Alaska",
         NAME != "Hawaii",
         !str_detect(NAME, "Puerto")) %>% 
  ggplot(aes(fill = total_pop)) +
  geom_sf() +
  scale_fill_viridis_c("Total Population")
```

Plot the total population of each county in PA
```{r}
pennsylvania <- get_decennial(geography = "county",
                           variables = c(total_pop = "P001001"),
                           state = "PA",
                           geometry = TRUE,
                           output = "wide")

pennsylvania %>% 
  ggplot(aes(fill = total_pop)) +
  geom_sf(color = NA) +
  scale_fill_viridis_c()
```

Highlight Allegheny County
```{r}
allegheny <- pennsylvania %>% 
  filter(str_detect(NAME, "Allegheny"))

pennsylvania %>% 
  ggplot() +
  geom_sf(aes(fill = total_pop), color = NA) +
  geom_sf(data = allegheny, color = "white", linetype = 2, size = 1, alpha = 0) +
  scale_fill_viridis_c()
```

don't use
load census block data for total pop
```{r eval=FALSE, include=FALSE}
allegheny <- get_decennial(geography = "block",
                           variables = c(total_pop = "P001001"),
                           state = "PA", county = "Allegheny County",
                           geometry = TRUE)
```

don't use
graph
```{r eval=FALSE, include=FALSE}
allegheny %>% 
  ggplot(aes(fill = value)) +
  geom_sf(color = NA) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c("Total Population")
```

Download demographic data for census blocks

Set the variables we want to use first
```{r}
racevars <- c(White = "P005003", 
              Black = "P005004", 
              Asian = "P005006", 
              Hispanic = "P004003")

#note that this data is long, not wide
allegheny <- get_decennial(geography = "tract", variables = racevars, 
                        state = "PA", county = "Allegheny County", geometry = TRUE,
                        summary_var = "P001001") 
```

Calculate as a percentage of tract population
```{r}
allegheny <- allegheny %>% 
  mutate(pct = 100 * value / summary_value)
```

graph
```{r}
allegheny %>% 
  ggplot(aes(fill = pct)) +
  geom_sf(color = NA) +
  facet_wrap(~variable) +
  #coord_sf(crs = 26915) + 
  scale_fill_viridis_c()
```

make rivers show up
```{r}
st_erase <- function(x, y) {
  st_difference(x, st_union(st_combine(y)))
}

allegheny_water <- area_water("PA", "Allegheny County", class = "sf")

allegheny %>% 
  ggplot() +
  geom_sf() +
  geom_sf(data = allegheny_water, fill = "blue")

#allegheny_erase <- st_erase(allegheny, allegheny_water)
```
```{r, eval=FALSE}
allegheny_erase %>% 
  ggplot(aes(fill = pct)) +
  geom_sf(color = NA) +
  facet_wrap(~variable) +
  coord_sf(crs = 26915) + 
  scale_fill_viridis_c()
```

We can overlay the boundaries of Pittsburgh over the same graph.

Download the [boundary shapefile](https://catalog.data.gov/dataset/pittsburgh-city-boundary-cbe8f) and use `sf::st_read` to read it into R
```{r}
city_pgh <- st_read("Pittsburgh_City_Boundary/Pittsburgh_City_Boundary.shp")

allegheny %>% 
  ggplot() +
  geom_sf(aes(fill = pct), color = NA) +
  geom_sf(data = city_pgh, color = "white", line_type = 2, size = 1, alpha = 0) +
  facet_wrap(~variable) + 
  scale_fill_viridis_c()
```

#WPRDC fire data
```{r eval=FALSE, include=FALSE}
pgh_fire_shp <- st_read("Allegheny_County_Census_Block_Groups_2016/Allegheny_County_Census_Block_Groups_2016.shp")

pgh_fire_districts <- st_read("Fire_Districts/Fire_Districts.shp")

pgh_fire <- read_csv("911-fire-dispatches.csv", col_types = cols(.default = "c")) 
  
pgh_fire <- pgh_fire %>% 
  count(GEOID, sort = TRUE) %>% 
  filter(GEOID != "420034520001")

pgh_fire_shp <- pgh_fire_shp %>% 
  #semi_join(pgh_fire) %>% 
  left_join(pgh_fire)

pgh_fire_shp %>% 
  ggplot() +
  geom_sf(aes(fill = n), color = NA) +
  scale_fill_viridis_c()

pgh_fire_districts %>% 
  ggplot() +
  geom_sf()
```

We can also download the shapefile for the [City of Pittsburgh wards](https://catalog.data.gov/dataset/pittsburgh-wards). The [311 dataset](https://data.wprdc.org/dataset/311-data/resource/76fda9d0-69be-4dd5-8108-0de7907fc5a4) is tagged with the ward the request originated from, so we can use that to aggregate and map the total number of 311 calls per ward.
```{r}
df_311 <- read_csv("https://data.wprdc.org/datastore/dump/76fda9d0-69be-4dd5-8108-0de7907fc5a4")

wards <- st_read("PGHWards/PGHWards.shp")

wards %>% 
  ggplot() +
  geom_sf()
```
Calculate the center of each ward. We will use this to label the wards on the map:
```{r}
ward_labels <- wards %>% 
  st_centroid() %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  clean_names()

ward_labels %>% 
  head(5) %>%
  kable() %>% 
  kable_styling()
```
Count the number of requests per ward:
```{r}
df_311_count <- df_311 %>% 
  count(WARD, sort = TRUE)
```
Join the count data with the coordinates:
```{r}
ward_311 <- wards %>% 
  left_join(df_311_count, by = c("ward" = "WARD")) %>%
  bind_cols(ward_labels)
```
Plot the data:
```{r}
ward_311 %>% 
  ggplot() +
  geom_sf(aes(fill = n), color = NA) +
  geom_label(aes(x, y, label = ward), size = 3) +
  scale_fill_viridis_c("Number of 311 requests")
```

We can use `ggmap` to request a basemap from the Google Maps API.
Get your API key [here](https://cloud.google.com/maps-platform/)
```{r include=FALSE}
register_google(key = "Your key here")
```
```{r}
pgh_map <- get_map(location = "Pittsburgh, PA", zoom = 12)

ggmap(pgh_map)
```

This combination requires a certain map projection. Use `coord_sf` to set the projection.
```{r}
ggmap(pgh_map) +
  geom_sf(data = ward_311, aes(fill = n), inherit.aes = FALSE, color = NA, alpha = .7) +
  geom_label(data = ward_311, aes(x, y, label = ward), size = 3) +
  coord_sf(crs = st_crs(4326)) +
  scale_fill_viridis_c("Number of 311 requests")
```

##Links

*https://walkerke.github.io/tidycensus/articles/basic-usage.html
*https://walkerke.github.io/tidycensus/reference/get_acs.html
*https://walkerke.github.io/tidycensus/articles/spatial-data.html
*https://walkerke.github.io/tidycensus/articles/other-datasets.html
*https://cengel.github.io/R-spatial/mapping.html
*https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html
*https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html
*https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-3.html
*google maps API key: https://cloud.google.com/maps-platform/
*https://lucidmanager.org/geocoding-with-ggmap/
